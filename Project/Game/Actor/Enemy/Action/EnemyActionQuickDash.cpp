#include "EnemyActionQuickDash.h"
#include "Game/Actor/Enemy/BaseEnemy.h"
#include "Engine/Lib/Math/MyRandom.h"

EnemyActionQuickDash::EnemyActionQuickDash() {
    param_.Load();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行処理
///////////////////////////////////////////////////////////////////////////////////////////////


BehaviorStatus EnemyActionQuickDash::Execute() {
    return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 重みを計算
///////////////////////////////////////////////////////////////////////////////////////////////

float EnemyActionQuickDash::EvaluateWeight() {
    return 0.0f;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void EnemyActionQuickDash::Debug_Gui() {
    BaseTaskNode::Debug_Gui();
    param_.Debug_Gui();
}

void EnemyActionQuickDash::Parameter::Debug_Gui() {
    ImGui::DragFloat("speed", &speed, 0.1f);
    ImGui::DragFloat("moveTime", &moveTime, 0.1f);
    curve.Debug_Gui();
    SaveAndLoad();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool EnemyActionQuickDash::IsFinish() {
    if (taskTimer_ >= param_.moveTime) {
        return true;
    }
    return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool EnemyActionQuickDash::CanExecute() {
    return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void EnemyActionQuickDash::Init() {
    param_.Load();

    // 移動方向をランダムに決める
    moveDirection_ = Random::RandomVector3(CVector3::UNIT * -1.0f, CVector3::UNIT);
    moveDirection_.y = 0;
    moveDirection_ = moveDirection_.Normalize();

}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void EnemyActionQuickDash::Update() {
    taskTimer_ += AOENGINE::GameTimer::DeltaTime();

    Move();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void EnemyActionQuickDash::End() {
}

void EnemyActionQuickDash::Move() {
    float t = taskTimer_ / param_.moveTime;
    float curveValue = param_.curve.BezierValue(t);

    float speed = param_.speed * curveValue;
    pTarget_->GetTransform()->MoveVelocity(moveDirection_ * speed * AOENGINE::GameTimer::DeltaTime(), 1.0f);
}