#include "BossActionAdjustHeight.h"
#include "Game/Actor/Boss/Boss.h"
#include "Engine/Lib/Json/JsonItems.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行をする
///////////////////////////////////////////////////////////////////////////////////////////////

BehaviorStatus BossActionAdjustHeight::Execute() {
    return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 評価値を計算
///////////////////////////////////////////////////////////////////////////////////////////////

float BossActionAdjustHeight::EvaluateWeight() {
    return pTarget_->GetEvaluationFormula()->HeightEvaluation(2.0f, 10.0f);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::Debug_Gui() {
    ITaskNode::Debug_Gui();
    param_.Debug_Gui();
}

void BossActionAdjustHeight::Parameter::Debug_Gui() {
    ImGui::DragFloat("smoothTime", &smoothTime, 0.1f);
    ImGui::DragFloat("maxSpeed", &maxSpeed, 0.1f);
    SaveAndLoad();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionAdjustHeight::IsFinish() {
    if (distance_ < 2.0f) {
        return true;
    }

    if (taskTimer_ < 2.0f) {
        return true;
    }

    return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionAdjustHeight::CanExecute() {
    return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::Init() {
    param_.SetGroupName("BossAction");
    param_.Load();
    speed_ = 0.0f;

    taskTimer_ = 0.0f;

    pTarget_->SetIsMove(true);
    pTarget_->SetIsAttack(false);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::Update() {
    taskTimer_ += GameTimer::DeltaTime();
    // playerとの高さを合わせる
    distance_ = SmoothDamp(pTarget_->GetPosition().y, pTarget_->GetPlayerPosition().y, speed_, param_.smoothTime, param_.maxSpeed, GameTimer::DeltaTime());
    pTarget_->GetTransform()->SetTranslationY(distance_);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::End() {
    pTarget_->SetIsMove(false);
}
