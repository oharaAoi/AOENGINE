#include "BossActionAdjustHeight.h"
#include "Game/Actor/Boss/Boss.h"
#include "Engine/Lib/Json/JsonItems.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行をする
///////////////////////////////////////////////////////////////////////////////////////////////

BossActionAdjustHeight::BossActionAdjustHeight() {
	param_.Load();
}

BehaviorStatus BossActionAdjustHeight::Execute() {
	return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 評価値を計算
///////////////////////////////////////////////////////////////////////////////////////////////

float BossActionAdjustHeight::EvaluateWeight() {
	// targetとの距離を測る
	float distance = std::abs(pTarget_->GetTargetPos().y - pTarget_->GetPosition().y);
	float t = std::clamp((distance - param_.appropriateDistance) / param_.maxDistance, 0.0f, 1.0f);
	return t * t;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::Debug_Gui() {
	BaseTaskNode::Debug_Gui();
	param_.Debug_Gui();
}

void BossActionAdjustHeight::Parameter::Debug_Gui() {
	ImGui::DragFloat("移動速度", &speed);
	ImGui::DragFloat("適正距離", &appropriateDistance);
	ImGui::DragFloat("最大距離", &maxDistance);
	ImGui::DragFloat("移動時間", &moveTime);
	moveCurve.Debug_Gui();
	SaveAndLoad();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionAdjustHeight::IsFinish() {
	if (taskTimer_ >= param_.moveTime) {
		return true;
	}
	return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionAdjustHeight::CanExecute() {
	return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::Init() {
	taskTimer_ = 0.0f;

	pTarget_->SetIsMove(true);
	pTarget_->SetIsAttack(false);

	pRigidbody_ = pTarget_->GetGameObject()->GetRigidbody();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::Update() {
	float distance = pTarget_->GetTargetPos().y - pTarget_->GetPosition().y;

	taskTimer_ += AOENGINE::GameTimer::DeltaTime();
	float t = taskTimer_ / param_.moveTime;
	float bezier = param_.moveCurve.BezierValue(t);

	float sign = 1;
	if (distance < 0.0f) {
		sign *= -1.0f;
	}

	speedY_ = (param_.speed * bezier * sign) * AOENGINE::GameTimer::DeltaTime();
	pRigidbody_->AddVelocityY(speedY_);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionAdjustHeight::End() {
	pTarget_->SetIsMove(false);
	pRigidbody_->SetVelocityY(0);
}
