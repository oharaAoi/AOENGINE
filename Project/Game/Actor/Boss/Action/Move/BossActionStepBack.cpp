#include "BossActionStepBack.h"
#include "Game/Actor/Boss/Boss.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ コンストラクタ
///////////////////////////////////////////////////////////////////////////////////////////////

BossActionStepBack::BossActionStepBack() {
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行処理
///////////////////////////////////////////////////////////////////////////////////////////////

BehaviorStatus BossActionStepBack::Execute() {
    return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

float BossActionStepBack::EvaluateWeight() {
    float distance = std::abs(pTarget_->GetTargetPos().y - pTarget_->GetPosition().y);
    return evaluator_.Evaluate(distance);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionStepBack::Debug_Gui() {
    BaseTaskNode::Debug_Gui();
    param_.Debug_Gui();
}

void BossActionStepBack::Parameter::Debug_Gui() {
    ImGui::DragFloat("speed", &speed, 0.1f);
    ImGui::DragFloat("moveTime", &moveTime, 0.1f);
    ImGui::DragFloat("minDecel", &minDecel, 0.1f);
    ImGui::DragFloat("maxDecel", &maxDecel, 0.1f);
    ImGui::DragFloat("stopThreshold", &stopThreshold, 0.1f);
    decelCurve.Debug_Gui();
    SaveAndLoad();
}


///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionStepBack::IsFinish() {
    if (velocity_.Length() < param_.stopThreshold) {
        return true;
    }

    return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionStepBack::CanExecute() {
    return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionStepBack::Init() {
    pTarget_->SetIsMove(true);
    pTarget_->SetIsAttack(false);
    taskTimer_ = 0;

    direction_ = pTarget_->GetTargetPos() - pTarget_->GetPosition();
    direction_.y = 0;
    direction_ = direction_.Normalize();
    direction_ *= -1.0f;

    velocity_ += direction_ * param_.speed;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionStepBack::Update() {
    float dt = AOENGINE::GameTimer::DeltaTime();
    taskTimer_ += dt;

    float t = taskTimer_ / param_.moveTime;
    t = std::clamp(t, 0.0f, 1.0f);

    float bezierValue = param_.decelCurve.BezierValue(t);
    float decelRate = std::lerp(param_.minDecel, param_.maxDecel, bezierValue);

    // 後半ほど入力を弱める
    float accelFactor = 1.0f - t;
    velocity_ += direction_ * param_.speed * accelFactor * dt;

    // 指数減衰
    velocity_ *= std::exp(-decelRate * dt);

    AOENGINE::Rigidbody* rigid = pTarget_->GetGameObject()->GetRigidbody();
    rigid->SetVelocity(velocity_);

    pTarget_->TargetLook();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionStepBack::End() {
    pTarget_->SetIsMove(false);

    AOENGINE::Rigidbody* rigid = pTarget_->GetGameObject()->GetRigidbody();
    rigid->SetVelocity(CVector3::ZERO);
}
