#include "BossActionTurnBehind.h"
#include "Game/Actor/Boss/Boss.h"
#include "Engine/Lib/GameTimer.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTurnBehind::Debug_Gui() {
	BaseTaskNode::Debug_Gui();
	param_.Debug_Gui();
}

void BossActionTurnBehind::Parameter::Debug_Gui() {
	ImGui::DragFloat("moveSpeed", &moveSpeed);
	ImGui::DragFloat("moveTime", &moveTime);
	moveCurve.Debug_Gui();
	SaveAndLoad();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行処理
///////////////////////////////////////////////////////////////////////////////////////////////

BehaviorStatus BossActionTurnBehind::Execute() {
	return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 評価値の計算
///////////////////////////////////////////////////////////////////////////////////////////////

float BossActionTurnBehind::EvaluateWeight() {
	return 0.6f;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionTurnBehind::IsFinish() {
	if (taskTimer_ >= param_.moveTime) {
		pRigidBody_->SetVelocity(CVector3::ZERO);
		return true;
	}
	return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionTurnBehind::CanExecute() {
	return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTurnBehind::Init() {
	param_.Load();
	taskTimer_ = 0;

	Math::Vector3 center = pTarget_->GetTargetPos();
	Math::Vector3 pos = pTarget_->GetTransform()->GetPos();

	toCenter_ = pos - center;
	toCenter_ = toCenter_.Normalize();

	velocity_ = CVector3::ZERO;

	pTarget_->SetIsMove(true);
	pTarget_->SetIsAttack(false);

	pRigidBody_ = pTarget_->GetGameObject()->GetRigidbody();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTurnBehind::Update() {
	taskTimer_ += AOENGINE::GameTimer::DeltaTime();
	Move();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTurnBehind::End() {
	pTarget_->SetIsMove(false);
	pRigidBody_->SetVelocity(CVector3::ZERO);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 移動処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTurnBehind::Move() {
	float t = taskTimer_ / param_.moveTime;
	float bezierValue = param_.moveCurve.BezierValue(t);

	// XZ平面で90度回転
	Math::Vector3 tangent = { toCenter_.z, 0.0f, toCenter_.x };
	// 円運動速度
	acceleration_ = tangent * (param_.moveSpeed * bezierValue);
	velocity_ += acceleration_ + AOENGINE::GameTimer::DeltaTime();
	// 速度の更新
	pRigidBody_->AddVelocity(acceleration_ * AOENGINE::GameTimer::DeltaTime());

	Math::Quaternion rot = pRigidBody_->LookVelocity(pTarget_->GetTransform()->GetRotate(), 1.0f);
	pTarget_->GetTransform()->SetRotate(rot);
}