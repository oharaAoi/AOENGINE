#include "BossActionShotLauncher.h"
#include "Engine/Lib/Json/JsonItems.h"
#include "Game/Actor/Boss/Boss.h"
#include "Game/Actor/Boss/Action/BossActionIdle.h"
#include "Game/Actor/Boss/Bullet/BossMissile.h"
#include "Game/UI/Boss/BossUIs.h"

BehaviorStatus BossActionShotLauncher::Execute() {
	return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotLauncher::Debug_Gui() {
	if (ImGui::CollapsingHeader("Parameter")) {
		ImGui::DragFloat("bulletSpeed", &param_.bulletSpeed, .1f);
		ImGui::DragFloat("stiffenTime", &param_.stiffenTime, .1f);

		if (ImGui::Button("Save")) {
			JsonItems::Save("BossAction", param_.ToJson(param_.GetName()));
		}
		if (ImGui::Button("Apply")) {
			param_.FromJson(JsonItems::GetData("BossAction", param_.GetName()));
		}
	}

	weight_->Debug_Gui();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionShotLauncher::IsFinish() {
	if (isFinish_) {
		return false;
	}
	return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionShotLauncher::CanExecute() {
	return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotLauncher::Init() {
	weight_ = std::make_unique<BossLotteryAction>();
	weight_->Init("actionShotLauncherWeight");

	size_t hash = typeid(BossActionShotLauncher).hash_code();
	pTarget_->GetAI()->SetAttackWeight(hash, weight_.get());

	taskTimer_ = 0.0f;
	param_.FromJson(JsonItems::GetData("BossAction", param_.GetName()));
	Shot();

	isFinish_ = true;

	// 警告を出す
	pTarget_->GetUIs()->PopAlert();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotLauncher::Update() {
	taskTimer_ += GameTimer::DeltaTime();

	if (taskTimer_ > param_.stiffenTime) {
		isFinish_ = true;
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotLauncher::End() {
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ main Action
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotLauncher::Shot() {
	Vector3 pos = pTarget_->GetPosition();
	Vector3 velocity = (pTarget_->GetPlayerPosition() - pos).Normalize();
	BossMissile* bullet = pTarget_->GetBulletManager()->AddBullet<BossMissile>(pos, velocity, pTarget_->GetPlayerPosition(), param_.bulletSpeed, 0.0f, false);
	bullet->SetTakeDamage(40.0f);
}