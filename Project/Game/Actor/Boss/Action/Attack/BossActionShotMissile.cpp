#include "BossActionShotMissile.h"
#include "Game/Actor/Boss/Boss.h"
#include "Game/Actor/Boss/Bullet/BossMissile.h"
#include "Game/UI/Boss/BossUIs.h"

BehaviorStatus BossActionShotMissile::Execute() {
	return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotMissile::Debug_Gui() {
	weight_->Debug_Gui();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionShotMissile::IsFinish() {
	if (isFinishShot_) {
		return true;
	}
	return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionShotMissile::CanExecute() {
	return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotMissile::Init() {
	weight_ = std::make_unique<BossLotteryAction>();
	weight_->Init("actionShotMissleWeight");

	size_t hash = typeid(BossActionShotMissile).hash_code();
	pTarget_->GetAI()->SetAttackWeight(hash, weight_.get());

	taskTimer_ = 0.0f;
	bulletSpeed_ = 60.f;
	isFinishShot_ = false;

	fireCount_ = kFireCount_;

	shotInterval_ = 0.2f;

	// 警告を出す
	pTarget_->GetUIs()->PopAlert();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotMissile::Update() {
	taskTimer_ += GameTimer::DeltaTime();

	if (taskTimer_ > shotInterval_) {
		Shot();
		taskTimer_ = 0.0f;
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotMissile::End() {
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 弾を打つ処理をする
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionShotMissile::Shot() {
	fireCount_--;

	Vector3 pos = pTarget_->GetTransform()->translate_;
	Vector3 forward = pTarget_->GetTransform()->rotation_.MakeForward();
	Vector3 up = pTarget_->GetTransform()->rotation_.MakeUp(); // Y軸に限らず回転軸として使う

	Vector3 velocity = forward.Normalize() * bulletSpeed_;
	BossMissile* missile = pTarget_->GetBulletManager()->AddBullet<BossMissile>(pos, velocity, pTarget_->GetPlayerPosition(), bulletSpeed_, 0.5f, true);
	missile->SetTakeDamage(20.0f);

	if (fireCount_ == 0) {
		isFinishShot_ = true;
	}
}