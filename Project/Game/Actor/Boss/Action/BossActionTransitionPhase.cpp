#include "BossActionTransitionPhase.h"
#include "Game/Actor/Boss/Boss.h"
#include "Engine/Lib/GameTimer.h"
#include "Engine/System/Manager/ParticleManager.h"
#include "Engine/System/Manager/GpuParticleManager.h"
#include "Game/Actor/Boss/State/BossStateDeployArmor.h"

BossActionTransitionPhase::BossActionTransitionPhase() {
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行処理
///////////////////////////////////////////////////////////////////////////////////////////////

BehaviorStatus BossActionTransitionPhase::Execute() {
	return Action();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 評価値計算
///////////////////////////////////////////////////////////////////////////////////////////////

float BossActionTransitionPhase::EvaluateWeight() {
	return 1.0f;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTransitionPhase::Debug_Gui() {
	BaseTaskNode::Debug_Gui();
	param_.Debug_Gui();
}

void BossActionTransitionPhase::Parameter::Debug_Gui() {
	ImGui::DragFloat("chargeTime", &chargeTime, 0.1f);
	SaveAndLoad();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionTransitionPhase::IsFinish() {
	if (attackArmor_->GetIsFinish()) {
		return true;
	}
	return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 実行確認
///////////////////////////////////////////////////////////////////////////////////////////////

bool BossActionTransitionPhase::CanExecute() {
	if (pTarget_->GetPhase() == BossPhase::First) {
		return true;
	} else {
		return false;
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTransitionPhase::Init() {
	param_.Load();

	taskTimer_ = 0.0f;

	// ----------------------
	// ↓ effect
	// ----------------------
	chargeParticle_ = AOENGINE::GpuParticleManager::GetInstance()->CreateEmitter("bossChargeParticle");
	chargeParticle_->SetParent(pTarget_->GetTransform()->GetWorldMatrix());

	chargeLine_ = AOENGINE::ParticleManager::GetInstance()->CrateParticle("BossChargeLine");
	chargeLine_->SetParent(pTarget_->GetTransform()->GetWorldMatrix());
	chargeLine_->SetIsStop(false);

	attackArmor_ = std::make_unique<AttackArmor>();
	attackArmor_->Init();
	attackArmor_->Update();

	pTarget_->SetIsArmorDeploy(true);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTransitionPhase::Update() {
	taskTimer_ += AOENGINE::GameTimer::DeltaTime();

	if (taskTimer_ >= param_.chargeTime) {
		chargeParticle_->SetIsStop(true);
		chargeLine_->SetIsStop(true);
		attackArmor_->Start(pTarget_->GetPosition());

		pTarget_->GetState()->ChangeState<BossStateDeployArmor>();
	}

	attackArmor_->Update();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void BossActionTransitionPhase::End() {
	pTarget_->SetIsArmorDeploy(false);
	pTarget_->SetPhase(BossPhase::Second);
}
