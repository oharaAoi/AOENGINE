#include "PlayerActionTurnAround.h"
#include "Engine/Lib/Json/JsonItems.h"
#include "Game/Actor/Player/Player.h"
#include "Game/Actor/Player/Action/PlayerActionMove.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerActionTurnAround::Debug_Gui() {
	param_.Debug_Gui();
}

void PlayerActionTurnAround::Parameter::Debug_Gui() {
	ImGui::DragFloat("speed", &speed, 0.1f);
	ImGui::DragFloat("rotateTime", &rotateTime, 0.1f);
	SaveAndLoad();
}


///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 設定時のみ行う処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerActionTurnAround::Build() {
	SetName("actionTurnAround");

	param_.SetGroupName(pManager_->GetName());
	param_.Load();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 初期化
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerActionTurnAround::OnStart() {
	actionTimer_ = 0;
	speed_ = context_->Get<float>("speed");

	Vector2 current = Input::GetInstance()->GetLeftJoyStick(kDeadZone_).Normalize();
	direction_ = pOwner_->GetFollowCamera()->GetAngleX().Rotate(Vector3{ current.x, 0.0f, current.y });
	float angle = std::atan2f(direction_.x, direction_.z);

	prevRotate_ = pOwner_->GetTransform()->srt_.rotate;
	targetRotate_ = Quaternion::AngleAxis(angle, CVector3::UP);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerActionTurnAround::OnUpdate() {
	actionTimer_ += GameTimer::DeltaTime();

	float t = actionTimer_ / param_.rotateTime;
	pOwner_->GetTransform()->srt_.rotate = Quaternion::Slerp(prevRotate_, targetRotate_, t);
	pOwner_->GetTransform()->srt_.translate += direction_ * speed_ * GameTimer::DeltaTime();
	speed_ *= 0.9f;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerActionTurnAround::OnEnd() {

}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 次に行うアクションの判定
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerActionTurnAround::CheckNextAction() {
	if (actionTimer_ >= param_.rotateTime) {
		NextAction<PlayerActionMove>();
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 入力処理
///////////////////////////////////////////////////////////////////////////////////////////////

bool PlayerActionTurnAround::IsInput() {
	return false;
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ main action
///////////////////////////////////////////////////////////////////////////////////////////////