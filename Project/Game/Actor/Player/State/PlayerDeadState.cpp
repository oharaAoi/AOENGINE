#include "PlayerDeadState.h"
#include "Engine/Lib/GameTimer.h"
#include "Game/Actor/Player/Player.h"

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 編集処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerDeadState::Debug_Gui() {
	param_.Debug_Gui();
}

void PlayerDeadState::Parameter::Debug_Gui() {
	ImGui::DragFloat("knockbackTime", &knockbackTime, 0.1f);
	ImGui::DragFloat("knockStrength", &knockStrength, 0.1f);
	ImGui::DragFloat("knockDecay", &knockDecay, 0.1f);
	SaveAndLoad();
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 開始処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerDeadState::OnStart() {
	param_.Load();

	timer_ = Timer(param_.knockbackTime);

	pOwner_->GetActionManager()->SetIsActionStop(true);
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 更新処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerDeadState::OnUpdate() {
	if (timer_.Run(GameTimer::DeltaTime())) {
		Knockback();
	} else {
		pOwner_->SetIsExpload(true);
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ 終了処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerDeadState::OnExit() {
}

///////////////////////////////////////////////////////////////////////////////////////////////
// ↓ ノックバック処理
///////////////////////////////////////////////////////////////////////////////////////////////

void PlayerDeadState::Knockback() {
	param_.knockStrength *= param_.knockDecay;

	// ノックバック方向のベクトルを取得
	Math::Vector3 direction = -pOwner_->GetTransform()->GetRotate().MakeForward();
	acceleration_ = (direction * param_.knockStrength) * GameTimer::DeltaTime();
	velocity_ += acceleration_ * GameTimer::DeltaTime();
	pOwner_->GetTransform()->srt_.translate += velocity_;
}